<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>思い出アプリ</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>思い出を共有しよう！</h1>

<form id="memoryForm">
  <input type="date" name="date" required />
  <input type="text" name="title" placeholder="出来事" required />
  <textarea name="message" placeholder="メッセージ"></textarea>
  <select name="author">
    <option value="れお">れお</option>
    <option value="ひまり">ひまり</option>
  </select>
  <select name="category" required>
    <option value="ルール">ルール</option>
    <option value="ありがとう">ありがとう</option>
    <option value="おめでとう">おめでとう</option>
    <option value="ごめんなさい">ごめんなさい</option>
  </select>
  <button type="submit">投稿</button>
</form>

<!-- 固定フォルダ -->
<div class="category-folder" id="folder-ルール">
  <div class="folder-header">ルール</div>
  <div class="folder-content"></div>
</div>
<div class="category-folder" id="folder-ありがとう">
  <div class="folder-header">ありがとう</div>
  <div class="folder-content"></div>
</div>
<div class="category-folder" id="folder-おめでとう">
  <div class="folder-header">おめでとう</div>
  <div class="folder-content"></div>
</div>
<div class="category-folder" id="folder-ごめんなさい">
  <div class="folder-header">ごめんなさい</div>
  <div class="folder-content"></div>
</div>

<script>
function sanitizeCategory(cat) {
  return cat.replace(/\s/g, '');
}

async function loadMemories() {
  const res = await fetch('/api/memories');
  const data = await res.json();

  // 一旦フォルダ内をクリア
  ['ルール','ありがとう','おめでとう','ごめんなさい'].forEach(cat => {
    document.querySelector(`#folder-${sanitizeCategory(cat)} .folder-content`).innerHTML = '';
  });

  data.forEach(m => {
    const folder = document.getElementById(`folder-${sanitizeCategory(m.category)}`);
    folder.querySelector('.folder-content').innerHTML += `
      <div class="memory-item category-${sanitizeCategory(m.category)}">
        <div class="memory-date">${m.date}</div>
        <div class="memory-title">${m.title}</div>
        <div class="memory-message">${m.message}</div>
        <div class="memory-author">by ${m.author}</div>
        <button onclick="deleteMemory(${m.id})">削除</button>
      </div>
    `;
  });

  // 折りたたみ
  document.querySelectorAll('.folder-header').forEach(header => {
    header.addEventListener('click', () => {
      const content = header.nextElementSibling;
      content.style.display = content.style.display === 'block' ? 'none' : 'block';
    });
  });
}

async function deleteMemory(id) {
  await fetch(`/api/memories/${id}`, { method: 'DELETE' });
  loadMemories();
}

document.getElementById('memoryForm').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const memory = {
    date: form.date.value,
    title: form.title.value,
    message: form.message.value,
    author: form.author.value,
    category: form.category.value
  };
  await fetch('/api/memories', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(memory)
  });
  form.reset();
  loadMemories();
});

loadMemories();
</script>
</body>
</html>
